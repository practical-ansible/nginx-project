---
- name: Check required variables
  assert:
    that:
      - '{{ item }} is defined'
      - item
  with_items:
    - 'admin_email'

- name: Enable nginx app
  file:
    src: '{{ file_site_config }}'
    dest: '/etc/nginx/sites-enabled/{{ instance_id }}.conf'
    state: link
  notify:
    - reload nginx
  when: state == 'present'

- name: Create SSL cert storage
  file:
    dest: '{{ dir_ssl }}'

- include_tasks: config-ssl-self-signed.yml
  when: ssl_sign_by == 'self'

- include_tasks: config-ssl-letsencrypt.yml
  when: ssl_sign_by == 'letsencrypt'

- name: Configure nginx SSL config file
  template:
    src: nginx-ssl.conf
    dest: '{{ file_site_config }}'
  notify:
    - reload nginx
